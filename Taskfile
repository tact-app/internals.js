#!/usr/bin/env bash

set -euo pipefail

[ "${BASH_VERSINFO:-0}" -ge 4 ] || {
  echo "bash version 4 or higher is required" >&2
  exit 1
}

paths=(
  "$(pwd)/node_modules/.bin"
  "$(pwd)/tools/node_modules/.bin"
)
for path in "${paths[@]}"; do
  if [[ ":${PATH}:" != *":${path}:"* ]]; then
    export PATH="${path}:${PATH}"
  fi
done



declare -A config
config['dryrun']=false
config['port']=3000

setup() {
  set_fontawesome_token false || (echo The token is required && return 1)
  set_graphite_token false || true
  set_sentry_token false || true
  set_vercel_token false || true
  @env

  tools npm ci
  build --from-scratch

  local copied=false
  command -v pbcopy >/dev/null && echo source bin/activate | pbcopy && copied=true
  echo Run the next commands to complete setup:
  printf '├─ source bin/activate\t- to activate virtual environment (copied to clipboard: %s)\n' $copied
  printf '└─ run whoami \t\t- to show meta information about your environment\n'
}

set_fontawesome_token() { @store_token 'Font Awesome' fontawesome.token 36 "${1:-true}"; }
set_graphite_token() { @store_token Graphite graphite.token 60 "${1:-true}"; }
set_sentry_token() { @store_token Sentry sentry.token 64 "${1:-true}"; }
set_vercel_token() { @store_token Vercel vercel.token 24 "${1:-true}"; }
@store_token() {
  local name="${1}" key="${2}" length="${3}" update="${4:-true}"

  if ! ${update}; then
    local yn='N'
    read -rp "Do you have ${name}' token? (y/N) " yn
    case $yn in
    [yY]) ;;
    *) return 1 ;;
    esac
  fi

  local token
  echo Please enter "${name}" token:
  read -rs token
  token=${token## }
  token=${token%% }

  if [ "${#token}" -lt "${length}" ]; then
    echo 'Token is invalid.'
    exit 1
  fi
  git config "${key}" "${token}"
  echo 'Token saved.'

  [ "${update}" != false ] && @env || return 0
}

@env() {
  cat <<EOF >.env
FONTAWESOME_TOKEN=$(git config fontawesome.token)
GRAPHITE_TOKEN=$(git config graphite.token)
SENTRY_TOKEN=$(git config sentry.token)
VERCEL_TOKEN=$(git config vercel.token)
EOF
  cat <<EOF >.sentryclirc
[auth]
token=$(git config sentry.token)
EOF
}

@vne() {
  source .env
  git config fontawesome.token ${FONTAWESOME_TOKEN}
  git config graphite.token ${GRAPHITE_TOKEN}
  git config sentry.token ${SENTRY_TOKEN}
  git config vercel.token ${VERCEL_TOKEN}
}

refresh() {
  for remote in $(git remote | grep -v origin); do
    git fetch --prune --tags "${remote}"
  done
  git fetch --prune --tags --prune-tags origin

  local remote actual target shared
  remote=${1:-'@{u}'}
  actual=$(git rev-parse @)
  target=$(git rev-parse "${remote}")
  shared="$(git merge-base @ "${remote}")"
  if [ "${actual}" != "${target}" ]; then
    if ! git diff-index --quiet HEAD; then
      git stash -m 'stash before pull'
      trap 'git stash pop' EXIT
    fi
    git pull --force --rebase
  fi

  @deps install
  @deps tools
}

@deps() {
  case "${1}" in
  check) depcheck --ignores=pre-commit,prettier,@fortawesome/fontawesome-pro,@types/node ;;

  install)
    if ! @deps verify package-lock.json; then
      install --from-scratch
      md5sum package-lock.json >node_modules/package.lock
    fi
  ;;

  tools)
    if ! @deps verify tools/package-lock.json; then
      tools npm ci
      md5sum tools/package-lock.json >tools/node_modules/package.lock
    fi
  ;;

  verify)
    local file="${2:-package-lock.json}" lock
    lock=$(dirname "${file}")/node_modules/package.lock
    if [ ! -f "${lock}" ]; then
      return 1
    fi
    [ "$(cat "${lock}")" == "$(md5sum "${file}")" ]
    ;;
  esac
}

@changelog() {
  local latest
  latest=$(git describe --tags --abbrev=0 2>/dev/null)

  git log --oneline "${latest}"... | cat | awk '{$1=""; print $0}' | sed 's/^/-/' | sort
}

# Example: run isolated
#   - alias run=./Taskfile
#   - source bin/activate
#  Deploy to staging
#   - run deploy
#  Deploy to production
#   - run deploy prod
isolated() {
  docker run --rm -it \
    --env-file .env \
    -v "$(pwd)":/app \
    -w /app \
    --entrypoint=/bin/bash \
    node:18
}

# Example: run install --from-scratch
install() {
  [ "${1:-}" == '--from-scratch' ] && rm -rf node_modules
  local cmd='npm install'
  if [ -t package-lock.json ]; then
    cmd='npm ci'
  fi
  @node "${cmd} --ignore-scripts --include=dev"
}

dev() { @node 'npm run dev' -p 3000:3000; }

# Example: run build --from-scratch
# Example: run build docker --from-scratch
build() {
  # docker way
  if [ "${1:-}" == 'docker' ]; then
    if [ "${2:-}" == '--from-scratch' ]; then
      docker rmi tact-app/web:local || true
    fi
    docker build \
      --build-arg token="$(git config fontawesome.token)" \
      -f Dockerfile \
      -t tact-app/web:local .
    return
  fi

  # local way
  [ "${1:-}" == '--from-scratch' ] && rm -rf .next && install "${@}"
  @node 'npm run build'
}

# Example: run start --from-scratch
# Example: run start docker --from-scratch
start() {
  # docker way
  if [ "${1:-}" == 'docker' ]; then
    [ "${2:-}" == '--from-scratch' ] && build docker "${@:2}"
    docker run \
      --rm -it \
      -p 127.0.0.1:"${config['port']}":3000 \
      tact-app/web:local
    return
  fi

  # local way
  [ "${1:-}" == '--from-scratch' ] && build "${@}"
  @node 'npm run start' -p 127.0.0.1:"${config['port']}":3000
}

npm() { @node "npm ${*}"; }

@node() {
  docker run --rm -it \
    --env-file .env \
    -v "$(pwd)":/app \
    -w /app \
    "${@:2}" \
    --entrypoint=/bin/sh \
    node:18-alpine -c "${1}"
}

# Example: run tools npm i vercel@latest
# Example: run tools npm ci
tools() {
  # dirty hack related to "docker: open .env: no such file or directory"
  unset -f npm

  (cd tools && "${@}")
}

_gt=$(which gt || true)
gt() {
  [ -z "${_gt}" ] && echo Please setup env and activate it. && return 1

  local token
  token=$(git config graphite.token)

  if [ ! -f ~/.graphite_user_config ]; then
    $_gt auth --token "${token}"
  elif [ "${token}" != "$(grep authToken ~/.graphite_user_config | awk '{print $2}' | tr -d '"')" ]; then
    $_gt auth --token "${token}"
  fi

  local args=("${@}")
  _ "${_gt}" "${args[@]}"
}

_sentry=$(which sentry-cli || true)
sentry() {
  [ -z "${_sentry}" ] && echo Please setup env and activate it. && return 1

  local args=("${@}")
  _ "${_sentry}" --auth-token="$(git config sentry.token)" "${args[@]}"
}

_vercel=$(which vercel || true)
vercel() {
  [ -z "${_vercel}" ] && echo Please setup env and activate it. && return 1

  if [ ! -f .vercel/project.json ]; then
    $_vercel -t "$(git config vercel.token)" link
  fi

  local args=("${@}")
  if [ "${1:-}" == 'clean' ]; then
    args=(rm --yes)
    if [ "${2:-}" == 'all' ]; then
      local deployment found=false
      while IFS='' read -r deployment; do
        args+=("${deployment}")
        found=true
      done < <(vercel ls 2>&1 | grep https | awk '{print $2}')
      if ! $found; then
        echo No deployments found.
        return
      fi
    else
      args+=(--safe tact)
    fi
  fi

  _ "${_vercel}" -t "$(git config vercel.token)" "${args[@]}"
}

# Example: run deploy prod
deploy() {
  if [ "${1:-}" == 'prod' ]; then
    vercel pull --yes --environment=production
    vercel build --yes --prod
    vercel deploy --yes --prebuilt --prod
    return
  fi

  vercel pull --yes --environment=preview
  vercel build --yes
  vercel deploy --yes --prebuilt
}

# Example: run docs
# Example: run docs build publish
function docs() {
  # dirty hack related to "docker: open .env: no such file or directory"
  unset -f npm

  pushd docs
  trap popd EXIT

  local args=("${@}")
  if [ ${#args[@]} = 0 ]; then
    args=(install build start)
  fi

  for arg in "${args[@]}"; do
    case "${arg}" in
    install)
      local lock file=package-lock.json
      lock=$(dirname "${file}")/node_modules/package.lock
      if [ ! -f "${lock}" ] || [ "$(cat "${lock}")" != "$(md5sum "${file}")" ]; then
        npm ci
        md5sum "${file}" >"${lock}"
      fi
      ;;

    build)
      npx --no-install next build
      ;;

    start)
      npx --no-install next start
      ;;

    publish)
      rm -rf dist/
      TARGET=static npx --no-install next build
      ;;

    *) break ;;
    esac
  done
}

whoami() {
  echo "You are $(git config user.name) <$(git config user.email)>"
  echo "* Docker ------------------------------------------"
  docker version
  echo "* Graphite ----------------------------------------"
  gt --version
  echo "* Sentry ------------------------------------------"
  sentry --version
  echo "* Vercel ------------------------------------------"
  vercel whoami
}

@debug() { echo "${@}"; }
@trace() { @debug "${@}" && "${@}"; }
@error() { echo "${@}" >&2; }
@fatal() { @error "${@}" && exit 1; }
@usage() {
  cat - <<EOF
Usage: $0 <task> <args>
Tasks:
EOF
  compgen -A function | grep -Ev '^(@|_|-|\+)' | sort | cat -n
}

@() {
  ${config['dryrun']} && echo "${@}"
  "${@}"
}

_() {
  if ${config['dryrun']}; then
    echo "${@}"
    return
  fi
  trap 'echo "${@}"' ERR
  "${@}"
}

-() {
  if ${config['dryrun']}; then
    echo "${*} || false"
    return
  fi
  trap 'echo "${*} || false"' ERR
  "${@}" || false
}

+() {
  if ${config['dryrun']}; then
    echo "${*} || true"
    return
  fi
  trap 'echo "${*} || true"' ERR
  "${@}" || true
}

function @main() {
  for arg in "${@}"; do
    case "${arg}" in
    -d | --dry-run)
      config['dryrun']=true
      shift
      ;;
    -p | --port)
      config['port']="${2}"
      shift 2
      ;;
    *) break ;;
    esac
  done
  "${@:-@usage}"
}

@main "${@}"
