#!/usr/bin/env bash

set -euo pipefail

install() {
  [ "${1:-}" == '--from-scratch' ] && rm -rf node_modules
  local cmd='npm install --include=dev'
  if [ -t package-lock.json ]; then
    cmd='npm ci --include=dev'
  fi

  docker run --rm -it \
    -v "$(pwd)":/app \
    -w /app \
    --entrypoint=/bin/sh \
    node:16-alpine -c "${cmd}"
}

build() {
  [ "${1:-}" == '--from-scratch' ] && rm -rf .next && install "${@}"

  docker run --rm -it \
    -v "$(pwd)":/app \
    -w /app \
    --entrypoint=/bin/sh \
    node:16-alpine -c 'npm run build'
}

server() {
  [ "${1:-}" == '--from-scratch' ] && build "${@}"

  docker run --rm -it \
    -p 127.0.0.1:3000:3000 \
    -v "$(pwd)":/app \
    -w /app \
    --entrypoint=/bin/sh \
    node:16-alpine -c 'npm run start'
}

# Examples:
#  - run tools npm i vercel@latest
tools() {
  pushd tools
  trap popd EXIT

  case "${1}" in
  npm)
    docker run --rm -it \
      -v "$(pwd)":/tools \
      -w /tools \
      --entrypoint=/bin/sh \
      node:16-alpine -c "${*}"
    ;;
  esac
}

env() {
  # TODO:improve support custom host with https
  #    sudo code /etc/hosts <- 127.0.0.1  tact.dev tact.local
  #    sudo killall -HUP mDNSResponder; echo DNS Cache Reset
  #  https://web.dev/how-to-use-local-https/
  #  https://github.com/FiloSottile/mkcert
  return 1
}

help() {
  echo "$0 <task> <args>"
  echo "Tasks:"
  compgen -A function | grep -v '^__' | sort | cat -n
}

__default() { help; }

"${@:-__default}"
